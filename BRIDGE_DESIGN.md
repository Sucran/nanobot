# nanobot Bridge è®¾è®¡è¯´æ˜æ–‡æ¡£

## ç›®å½•

1. [æ¶æ„æ¦‚è¿°](#æ¶æ„æ¦‚è¿°)
2. [Bridge è®¾è®¡æ¨¡å¼](#bridge-è®¾è®¡æ¨¡å¼)
3. [WhatsApp Bridge å®ç°](#whatsapp-bridge-å®ç°)
4. [Telegram Channel å®ç°](#telegram-channel-å®ç°)
5. [ä¸¤ç§æ–¹æ¡ˆçš„å¯¹æ¯”](#ä¸¤ç§æ–¹æ¡ˆçš„å¯¹æ¯”)
6. [æ‰©å±•æŒ‡å—](#æ‰©å±•æŒ‡å—)

---

## æ¶æ„æ¦‚è¿°

nanobot é‡‡ç”¨**å¤šè¯­è¨€æ··åˆæ¶æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·æ¶ˆæ¯æ¥æº                            â”‚
â”‚         WhatsApp        Telegram        å…¶ä»–æ¸ é“            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                â”‚                â”‚
           â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WhatsApp Bridge â”‚  â”‚ Telegram Channel â”‚  â”‚   å…¶ä»– Bridge    â”‚
â”‚   (Node.js)      â”‚  â”‚    (Python)      â”‚  â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                     â”‚                     â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     MessageBus         â”‚
                    â”‚    (Python å¼‚æ­¥é˜Ÿåˆ—)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      AgentLoop         â”‚
                    â”‚    (Python æ ¸å¿ƒé€»è¾‘)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®¾è®¡å“²å­¦**ï¼š
- **æ ¸å¿ƒé€»è¾‘ç»Ÿä¸€**ï¼šAgentLoopã€æ¶ˆæ¯æ€»çº¿ã€å·¥å…·ç³»ç»Ÿå…¨éƒ¨ç”¨ Python å®ç°
- **æ¸ é“é€‚é…çµæ´»**ï¼šæ ¹æ®æ¸ é“ç‰¹æ€§é€‰æ‹©æœ€ä½³æŠ€æœ¯æ ˆ
- **ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼**ï¼šæ‰€æœ‰æ¸ é“é€šè¿‡ `InboundMessage` / `OutboundMessage` ä¸æ ¸å¿ƒé€šä¿¡

---

## Bridge è®¾è®¡æ¨¡å¼

### 1. æŠ½è±¡åŸºç±»è®¾è®¡ï¼ˆPython Channelï¼‰

```python
class BaseChannel(ABC):
    """èŠå¤©æ¸ é“æŠ½è±¡åŸºç±»"""
    
    name: str = "base"
    
    def __init__(self, config: Any, bus: MessageBus):
        self.config = config      # æ¸ é“é…ç½®
        self.bus = bus            # æ¶ˆæ¯æ€»çº¿
        self._running = False
    
    @abstractmethod
    async def start(self) -> None:
        """å¯åŠ¨æ¸ é“ï¼Œå¼€å§‹ç›‘å¬æ¶ˆæ¯"""
        pass
    
    @abstractmethod
    async def stop(self) -> None:
        """åœæ­¢æ¸ é“ï¼Œæ¸…ç†èµ„æº"""
        pass
    
    @abstractmethod
    async def send(self, msg: OutboundMessage) -> None:
        """å‘é€æ¶ˆæ¯åˆ°æ¸ é“"""
        pass
```

**æ ¸å¿ƒæ–¹æ³•**ï¼š
- `start()` / `stop()`: ç”Ÿå‘½å‘¨æœŸç®¡ç†
- `send()`: å‡ºç«™æ¶ˆæ¯å‘é€
- `_handle_message()`: å…¥ç«™æ¶ˆæ¯å¤„ç†ï¼ˆå°è£…ä¸º InboundMessage å‘é€åˆ°æ€»çº¿ï¼‰
- `is_allowed()`: è®¿é—®æ§åˆ¶ï¼ˆç™½åå•æœºåˆ¶ï¼‰

### 2. Bridge è®¾è®¡ï¼ˆNode.jsï¼‰

```typescript
// ç‹¬ç«‹çš„ Node.js è¿›ç¨‹ï¼Œé€šè¿‡ WebSocket ä¸ Python é€šä¿¡
class BridgeServer {
    private wss: WebSocketServer;      // WebSocket æœåŠ¡å™¨
    private wa: WhatsAppClient;        // WhatsApp å®¢æˆ·ç«¯
    private clients: Set<WebSocket>;   // è¿æ¥çš„ Python å®¢æˆ·ç«¯
    
    async start(): Promise<void> {
        // 1. å¯åŠ¨ WebSocket æœåŠ¡å™¨ï¼ˆç›‘å¬ Python è¿æ¥ï¼‰
        // 2. åˆå§‹åŒ– WhatsApp å®¢æˆ·ç«¯
        // 3. è½¬å‘æ¶ˆæ¯ï¼šWhatsApp â†” Python
    }
}
```

**é€šä¿¡åè®®**ï¼š

```typescript
// Python â†’ Bridge (å‘é€æ¶ˆæ¯)
interface SendCommand {
    type: 'send';
    to: string;      // ç›®æ ‡æ‰‹æœºå·/ç¾¤ç»„ID
    text: string;    // æ¶ˆæ¯å†…å®¹
}

// Bridge â†’ Python (æ”¶åˆ°æ¶ˆæ¯)
interface InboundMessage {
    type: 'message';
    id: string;
    sender: string;
    content: string;
    timestamp: number;
    isGroup: boolean;
}

// Bridge â†’ Python (çŠ¶æ€é€šçŸ¥)
interface StatusMessage {
    type: 'status' | 'qr' | 'error';
    ...
}
```

---

## WhatsApp Bridge å®ç°

### æŠ€æœ¯é€‰å‹

| ç»„ä»¶ | æŠ€æœ¯ | ç†ç”± |
|:---|:---|:---|
| è¿è¡Œæ—¶ | Node.js 20+ | Baileys åº“ä¾èµ– |
| WhatsApp åº“ | Baileys | å¼€æºã€æ— å®˜æ–¹ API é™åˆ¶ã€åŠŸèƒ½å®Œæ•´ |
| é€šä¿¡åè®® | WebSocket | åŒå‘å®æ—¶é€šä¿¡ã€è·¨è¯­è¨€æ”¯æŒ |
| QR ç  | qrcode-terminal | ç»ˆç«¯æ‰«ç ç™»å½• |

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WhatsApp Bridge                          â”‚
â”‚                     (Node.js è¿›ç¨‹)                          â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  WhatsAppClient â”‚        â”‚      BridgeServer        â”‚   â”‚
â”‚  â”‚    (Baileys)    â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚     (WebSocket)          â”‚   â”‚
â”‚  â”‚                 â”‚        â”‚                          â”‚   â”‚
â”‚  â”‚ - connect()     â”‚        â”‚ - port: 3001             â”‚   â”‚
â”‚  â”‚ - sendMessage() â”‚        â”‚ - handleCommand()        â”‚   â”‚
â”‚  â”‚ - onMessage     â”‚        â”‚ - broadcast()            â”‚   â”‚
â”‚  â”‚ - onQR          â”‚        â”‚                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚ WebSocket
                                          â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   Python nanobot      â”‚
                              â”‚   (WhatsAppChannel)   â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒå®ç°

#### 1. WhatsAppClient (Baileys å°è£…)

```typescript
export class WhatsAppClient {
    private sock: any;  // Baileys socket å®ä¾‹
    
    async connect(): Promise<void> {
        // 1. åŠ è½½è®¤è¯çŠ¶æ€ï¼ˆå®ç°æŒä¹…ç™»å½•ï¼‰
        const { state, saveCreds } = await useMultiFileAuthState(this.authDir);
        
        // 2. åˆ›å»º socket
        this.sock = makeWASocket({
            auth: { creds: state.creds, keys: ... },
            version,           // WhatsApp Web ç‰ˆæœ¬
            printQRInTerminal: false,  // è‡ªå®šä¹‰ QR å¤„ç†
            browser: ['nanobot', 'cli', VERSION],
            syncFullHistory: false,     // ä¸åŒæ­¥å†å²
        });
        
        // 3. äº‹ä»¶ç›‘å¬
        this.sock.ev.on('connection.update', (update) => {
            // å¤„ç†è¿æ¥çŠ¶æ€ï¼šqrï¼ˆæ‰«ç ï¼‰ã€openï¼ˆå·²è¿æ¥ï¼‰ã€closeï¼ˆæ–­å¼€ï¼‰
        });
        
        this.sock.ev.on('messages.upsert', ({ messages }) => {
            // å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯
        });
        
        this.sock.ev.on('creds.update', saveCreds);  // è‡ªåŠ¨ä¿å­˜è®¤è¯
    }
}
```

**å…³é”®ç‰¹æ€§**ï¼š
- **æŒä¹…ç™»å½•**ï¼šè®¤è¯ä¿¡æ¯ä¿å­˜åˆ° `~/.nanobot/whatsapp-auth/`
- **è‡ªåŠ¨é‡è¿**ï¼šéä¸»åŠ¨ç™»å‡ºæ—¶è‡ªåŠ¨é‡è¿ï¼ˆ5ç§’å»¶è¿Ÿï¼‰
- **æ¶ˆæ¯æå–**ï¼šæ”¯æŒæ–‡æœ¬ã€å›¾ç‰‡ã€è§†é¢‘ã€è¯­éŸ³ã€æ–‡æ¡£

#### 2. BridgeServer (WebSocket æœåŠ¡å™¨)

```typescript
export class BridgeServer {
    async start(): Promise<void> {
        // åˆ›å»º WebSocket æœåŠ¡å™¨ï¼ŒPython å®¢æˆ·ç«¯è¿æ¥
        this.wss = new WebSocketServer({ port: this.port });
        
        // åˆå§‹åŒ– WhatsApp
        this.wa = new WhatsAppClient({
            onMessage: (msg) => this.broadcast({ type: 'message', ...msg }),
            onQR: (qr) => this.broadcast({ type: 'qr', qr }),
            onStatus: (status) => this.broadcast({ type: 'status', status }),
        });
        
        // å¤„ç† Python å®¢æˆ·ç«¯è¿æ¥
        this.wss.on('connection', (ws) => {
            ws.on('message', async (data) => {
                const cmd = JSON.parse(data.toString());
                await this.handleCommand(cmd);  // è½¬å‘åˆ° WhatsApp
            });
        });
    }
    
    private async handleCommand(cmd: SendCommand): Promise<void> {
        if (cmd.type === 'send') {
            await this.wa.sendMessage(cmd.to, cmd.text);
        }
    }
}
```

#### 3. Python ç«¯é›†æˆ

```python
# nanobot/channels/whatsapp.py
class WhatsAppChannel(BaseChannel):
    """é€šè¿‡ Bridge è¿æ¥ WhatsApp"""
    
    async def start(self) -> None:
        # 1. å¯åŠ¨ Bridge è¿›ç¨‹ï¼ˆNode.jsï¼‰
        self._bridge_process = await asyncio.create_subprocess_exec(
            "node", "bridge/dist/index.js",
            env={"BRIDGE_PORT": "3001", ...}
        )
        
        # 2. è¿æ¥ WebSocket
        self._ws = await websockets.connect("ws://localhost:3001")
        
        # 3. ç›‘å¬æ¶ˆæ¯
        async for message in self._ws:
            data = json.loads(message)
            if data["type"] == "message":
                await self._handle_message(...)
            elif data["type"] == "qr":
                # æ˜¾ç¤ºäºŒç»´ç ç»™ç”¨æˆ·
                print(f"è¯·æ‰«ç : {data['qr']}")
    
    async def send(self, msg: OutboundMessage) -> None:
        # å‘é€æ¶ˆæ¯åˆ° Bridge
        await self._ws.send(json.dumps({
            "type": "send",
            "to": msg.chat_id,
            "text": msg.content
        }))
```

### å¯åŠ¨æµç¨‹

```
1. ç”¨æˆ·å¯åŠ¨ nanobot
   â”‚
   â–¼
2. nanobot å¯åŠ¨ WhatsAppChannel
   â”‚
   â–¼
3. WhatsAppChannel å¯åŠ¨ Bridge å­è¿›ç¨‹ï¼ˆNode.jsï¼‰
   â”‚
   â–¼
4. Bridge å¯åŠ¨ WebSocket æœåŠ¡å™¨ï¼ˆç«¯å£ 3001ï¼‰
   â”‚
   â–¼
5. Bridge åˆå§‹åŒ– Baileysï¼Œæ˜¾ç¤º QR ç 
   â”‚
   â–¼
6. ç”¨æˆ·æ‰«ç ï¼ŒWhatsApp Web è¿æ¥æˆåŠŸ
   â”‚
   â–¼
7. Python â†WebSocketâ†’ Node.js è¿æ¥å»ºç«‹ï¼Œå¼€å§‹è½¬å‘æ¶ˆæ¯
```

---

## Telegram Channel å®ç°

### æŠ€æœ¯é€‰å‹

| ç»„ä»¶ | æŠ€æœ¯ | ç†ç”± |
|:---|:---|:---|
| è¿è¡Œæ—¶ | Python asyncio | ä¸ nanobot æ ¸å¿ƒç»Ÿä¸€ |
| Telegram åº“ | python-telegram-bot | å®˜æ–¹æ¨èã€åŠŸèƒ½å®Œæ•´ã€æ–‡æ¡£ä¸°å¯Œ |
| é€šä¿¡æ–¹å¼ | Long Polling | æ— éœ€å…¬ç½‘ IPã€ç®€å•å¯é  |
| æ¶ˆæ¯æ ¼å¼ | HTML | æ”¯æŒæ ¼å¼åŒ–ã€æ¯” Markdown å®‰å…¨ |

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Telegram Channel                         â”‚
â”‚                     (Python åŸç”Ÿ)                           â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              TelegramChannel (BaseChannel)            â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚  Application â”‚â—„â”€â”€â”€â”€â–ºâ”‚  python-telegram-bot   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  (Polling)   â”‚      â”‚    (Long Polling)      â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                    â”‚                â”‚  â”‚
â”‚  â”‚  æ¶ˆæ¯å¤„ç†å™¨:                       â”‚ Telegram API   â”‚  â”‚
â”‚  â”‚  - _on_message()  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚  â”‚
â”‚  â”‚  - _on_start()                                      â”‚  â”‚
â”‚  â”‚                                                    â”‚  â”‚
â”‚  â”‚  å‘é€æ–¹æ³•:                                          â”‚  â”‚
â”‚  â”‚  - send() â†’ bot.send_message()                      â”‚  â”‚
â”‚  â”‚                                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ InboundMessage/OutboundMessage
                          â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚      MessageBus       â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒå®ç°

#### 1. TelegramChannel ç±»

```python
class TelegramChannel(BaseChannel):
    """Telegram æ¸ é“å®ç°ï¼ˆLong Polling æ¨¡å¼ï¼‰"""
    
    name = "telegram"
    
    def __init__(self, config: TelegramConfig, bus: MessageBus, ...):
        super().__init__(config, bus)
        self._app: Application | None = None  # PTB Application
        self._chat_ids: dict[str, int] = {}    # ç”¨æˆ· ID æ˜ å°„
    
    async def start(self) -> None:
        """å¯åŠ¨ Telegram Botï¼ˆLong Pollingï¼‰"""
        # 1. åˆ›å»º Application
        self._app = Application.builder().token(self.config.token).build()
        
        # 2. æ·»åŠ æ¶ˆæ¯å¤„ç†å™¨
        self._app.add_handler(
            MessageHandler(
                filters.TEXT | filters.PHOTO | filters.VOICE | ...,
                self._on_message
            )
        )
        
        # 3. å¯åŠ¨ Polling
        await self._app.updater.start_polling(
            drop_pending_updates=True  # å¿½ç•¥å¯åŠ¨å‰çš„æ—§æ¶ˆæ¯
        )
    
    async def send(self, msg: OutboundMessage) -> None:
        """å‘é€æ¶ˆæ¯åˆ° Telegram"""
        # Markdown â†’ Telegram HTML è½¬æ¢
        html_content = _markdown_to_telegram_html(msg.content)
        
        await self._app.bot.send_message(
            chat_id=int(msg.chat_id),
            text=html_content,
            parse_mode="HTML"
        )
```

#### 2. Markdown è½¬ Telegram HTML

Telegram çš„ HTML æ ¼å¼ä¸æ ‡å‡† Markdown æœ‰å·®å¼‚ï¼Œéœ€è¦è½¬æ¢ï¼š

```python
def _markdown_to_telegram_html(text: str) -> str:
    """å°† Markdown è½¬æ¢ä¸º Telegram å®‰å…¨çš„ HTML"""
    
    # 1. ä¿æŠ¤ä»£ç å—ï¼ˆé˜²æ­¢è¢«å…¶ä»–è§„åˆ™å¤„ç†ï¼‰
    code_blocks = []
    text = re.sub(r'```[\w]*\n?([\s\S]*?)```', 
                  lambda m: save_code_block(m), text)
    
    # 2. è½¬æ¢æ ¼å¼
    text = re.sub(r'\*\*(.+?)\*\*', r'<b>\1</b>', text)      # **ç²—ä½“** â†’ <b>
    text = re.sub(r'_(.+?)_', r'<i>\1</i>', text)             # _æ–œä½“_ â†’ <i>
    text = re.sub(r'\[([^\]]+)\]\(([^)]+)\)',                 # [é“¾æ¥](url) â†’ <a>
                  r'<a href="\2">\1</a>', text)
    
    # 3. æ¢å¤ä»£ç å—
    text = text.replace(f"\x00CB{i}\x00", 
                        f"<pre><code>{code}</code></pre>")
    
    return text
```

**è½¬æ¢è§„åˆ™**ï¼š
| Markdown | Telegram HTML |
|:---|:---|
| `**text**` | `<b>text</b>` |
| `_text_` | `<i>text</i>` |
| `[link](url)` | `<a href="url">link</a>` |
| `` `code` `` | `<code>code</code>` |
| ` ```code``` ` | `<pre><code>code</code></pre>` |

#### 3. åª’ä½“æ–‡ä»¶å¤„ç†

```python
async def _on_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
    """å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯ï¼ˆåŒ…æ‹¬åª’ä½“ï¼‰"""
    
    # 1. æå–æ–‡æœ¬å†…å®¹
    content_parts = []
    if message.text:
        content_parts.append(message.text)
    if message.caption:
        content_parts.append(message.caption)
    
    # 2. å¤„ç†åª’ä½“æ–‡ä»¶
    media_paths = []
    
    if message.photo:
        # ä¸‹è½½å›¾ç‰‡
        file = await self._app.bot.get_file(message.photo[-1].file_id)
        file_path = media_dir / f"{file_id}.jpg"
        await file.download_to_drive(str(file_path))
        media_paths.append(str(file_path))
        
    elif message.voice or message.audio:
        # ä¸‹è½½è¯­éŸ³ â†’ è½¬å½•
        file_path = ...
        transcription = await transcriber.transcribe(file_path)
        content_parts.append(f"[transcription: {transcription}]")
    
    # 3. å‘é€åˆ°æ¶ˆæ¯æ€»çº¿
    await self._handle_message(
        sender_id=str(user.id),
        chat_id=str(message.chat_id),
        content="\n".join(content_parts),
        media=media_paths,
        metadata={...}
    )
```

---

## ä¸¤ç§æ–¹æ¡ˆçš„å¯¹æ¯”

| ç»´åº¦ | WhatsApp (Bridge) | Telegram (Native) |
|:---|:---|:---|
| **æŠ€æœ¯æ ˆ** | Node.js + TypeScript | Python + asyncio |
| **è¿è¡Œæ–¹å¼** | ç‹¬ç«‹è¿›ç¨‹ï¼ˆå­è¿›ç¨‹ï¼‰ | åŒè¿›ç¨‹ï¼ˆåç¨‹ï¼‰ |
| **é€šä¿¡æ–¹å¼** | WebSocket | ç›´æ¥æ–¹æ³•è°ƒç”¨ |
| **åº“ä¾èµ–** | Baileys (ç¬¬ä¸‰æ–¹) | python-telegram-bot (å®˜æ–¹) |
| **è®¤è¯æ–¹å¼** | QR ç æ‰«ç  | Bot Token |
| **éƒ¨ç½²å¤æ‚åº¦** | é«˜ï¼ˆéœ€ Node.js ç¯å¢ƒï¼‰ | ä½ï¼ˆçº¯ Pythonï¼‰ |
| **å¯åŠ¨é€Ÿåº¦** | æ…¢ï¼ˆéœ€å¯åŠ¨å­è¿›ç¨‹ï¼‰ | å¿«ï¼ˆåŒè¿›ç¨‹ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | éœ€ç»•è¿‡å®˜æ–¹ API é™åˆ¶ | å®˜æ–¹ API å……è¶³ |

### è®¾è®¡å†³ç­–åˆ†æ

**ä¸ºä»€ä¹ˆé€‰æ‹© Bridge æ¨¡å¼å®ç° WhatsAppï¼Ÿ**

1. **æŠ€æœ¯é™åˆ¶**ï¼š
   - WhatsApp å®˜æ–¹ Business API éœ€è¦ Meta å•†ä¸šè´¦å·
   - ç¬¬ä¸‰æ–¹ Python åº“ï¼ˆå¦‚ yowsupï¼‰åŠŸèƒ½æœ‰é™ã€ç»´æŠ¤ä¸æ´»è·ƒ
   - Baileysï¼ˆNode.jsï¼‰æ˜¯ç›®å‰æœ€æˆç†Ÿçš„å¼€æºæ–¹æ¡ˆ

2. **æ¶æ„ä¼˜åŠ¿**ï¼š
   - Bridge è¿›ç¨‹å´©æºƒä¸å½±å“ Python æ ¸å¿ƒ
   - å¯ä»¥ç‹¬ç«‹å‡çº§ WhatsApp åº“
   - WebSocket åè®®ä¾¿äºå¤šè¯­è¨€é›†æˆ

**ä¸ºä»€ä¹ˆé€‰æ‹© Native æ¨¡å¼å®ç° Telegramï¼Ÿ**

1. **ç”Ÿæ€æˆç†Ÿ**ï¼š
   - python-telegram-bot åŠŸèƒ½å®Œæ•´ã€æ–‡æ¡£ä¸°å¯Œ
   - Long Polling ç®€å•å¯é ï¼Œæ— éœ€ Webhook

2. **æ€§èƒ½è€ƒè™‘**ï¼š
   - åŒè¿›ç¨‹é€šä¿¡å¼€é”€æ›´ä½
   - é¿å…å­è¿›ç¨‹ç®¡ç†å¤æ‚åº¦

---

## æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°çš„ Bridge æ¸ é“ï¼ˆå¦‚ Discordï¼‰

```typescript
// bridge/src/discord.ts
export class DiscordClient {
    // 1. å®ç° Discord bot è¿æ¥ï¼ˆä½¿ç”¨ discord.jsï¼‰
    // 2. æä¾› onMessageã€sendMessage æ¥å£
}

// bridge/src/server.ts - æ‰©å±•æ”¯æŒå¤šæ¸ é“
class BridgeServer {
    private discord: DiscordClient | null = null;
    
    async startDiscord(): Promise<void> {
        this.discord = new DiscordClient({
            onMessage: (msg) => this.broadcast({ 
                type: 'message', 
                channel: 'discord',
                ...msg 
            })
        });
    }
}
```

### æ·»åŠ æ–°çš„ Native æ¸ é“ï¼ˆå¦‚ Slackï¼‰

```python
# nanobot/channels/slack.py
class SlackChannel(BaseChannel):
    name = "slack"
    
    async def start(self) -> None:
        # ä½¿ç”¨ slack-sdk å®ç°
        self.client = SocketModeClient(...)
        self.client.socket_mode_request_listeners.append(self._on_message)
    
    async def send(self, msg: OutboundMessage) -> None:
        await self.client.chat_postMessage(
            channel=msg.chat_id,
            text=msg.content
        )
```

### é€‰æ‹©æ ‡å‡†

| æƒ…å†µ | æ¨èæ–¹æ¡ˆ |
|:---|:---|
| æœ‰æˆç†Ÿçš„ Python SDK | Nativeï¼ˆå¦‚ Telegramï¼‰ |
| åªæœ‰ Node.js SDK | Bridgeï¼ˆå¦‚ WhatsAppï¼‰ |
| å®˜æ–¹ API ä¸¥æ ¼é™åˆ¶ | Bridgeï¼ˆä½¿ç”¨é€†å‘åº“ï¼‰ |
| éœ€è¦å¤æ‚åª’ä½“å¤„ç† | Nativeï¼ˆå‡å°‘è·¨è¿›ç¨‹ä¼ è¾“ï¼‰ |

---

## æ€»ç»“

nanobot çš„ Bridge æ¶æ„æä¾›äº†**çµæ´»çš„æ¸ é“æ‰©å±•èƒ½åŠ›**ï¼š

1. **ç»Ÿä¸€æ¥å£**ï¼šæ‰€æœ‰æ¸ é“é€šè¿‡ `BaseChannel` ç»Ÿä¸€æ¥å…¥
2. **æŠ€æœ¯æ— å…³**ï¼šæ ¹æ® SDK ç”Ÿæ€é€‰æ‹© Python æˆ– Node.js å®ç°
3. **æ¶ˆæ¯æ ‡å‡†åŒ–**ï¼šç»Ÿä¸€çš„ `InboundMessage` / `OutboundMessage` æ ¼å¼
4. **é€šä¿¡è§£è€¦**ï¼šWebSocket Bridge æ¨¡å¼å®ç°å¤šè¯­è¨€åä½œ

è¿™ç§è®¾è®¡è®© nanobot å¯ä»¥å¿«é€Ÿé€‚é…ä»»ä½•èŠå¤©å¹³å°ï¼Œè€Œä¸å—é™äºå•ä¸€æŠ€æœ¯æ ˆã€‚

---

*æ–‡æ¡£ç”Ÿæˆæ—¶é—´ï¼š2026-02-05*  
*ä½œè€…ï¼šè‹ä¸èƒ– ğŸ¦Š*
